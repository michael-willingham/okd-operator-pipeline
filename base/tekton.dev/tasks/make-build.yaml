apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: make-build
  namespace: okd-team
spec:
  params:
    - name: subdirectory
      description: The subdirectory to run the build in
      type: string

  workspaces:
    - name: source
    - name: build-cache-root
      mountPath: /go/.cache
    - name: build-pkg
      mountPath: /go/pkg

  stepTemplate:
    name: task
    securityContext:
      runAsNonRoot: true
      runAsUser: 65532
    workingDir: $(workspaces.source.path)/$(params.subdirectory)
    image: quay.io/okd/go-bundle-tools:v1.1.2

  steps:
    - name: build
      command: ["make"]
      args: ["build"]

    - name: test
      command: ["make"]
      args: ["test"]