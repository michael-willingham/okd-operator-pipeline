From 13c427a3f98b1be161bf97d6ec2cee90bbdabaa6 Mon Sep 17 00:00:00 2001
From: SupremeMortal <6178101+SupremeMortal@users.noreply.github.com>
Date: Mon, 11 Mar 2024 19:09:44 +0000
Subject: [PATCH] OKDify

---
 Makefile             | 11 +++++++++++
 build/csv/csv-gen.sh | 18 +++++++++---------
 images/ceph/Makefile | 28 ++++++++++++++--------------
 3 files changed, 34 insertions(+), 23 deletions(-)

diff --git a/Makefile b/Makefile
index 140093b5f..25bf0a80d 100644
--- a/Makefile
+++ b/Makefile
@@ -264,3 +264,14 @@ help: ## Show this help menu.
 	@grep --no-filename -E '^[a-zA-Z_%-. ]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-30s\033[0m %s\n", $$1, $$2}'
 	@echo ""
 	@echo "$$HELPTEXT"
+
+.PHONY: okd-install okd-lint okd-build
+
+okd-install: install
+
+okd-lint:
+	@echo "Lint disabled"
+
+okd-build: build
+
+okd-test: test
\ No newline at end of file
diff --git a/build/csv/csv-gen.sh b/build/csv/csv-gen.sh
index cab017e01..1dad2d4aa 100755
--- a/build/csv/csv-gen.sh
+++ b/build/csv/csv-gen.sh
@@ -13,17 +13,17 @@ YQ_CMD_DELETE=("$yq" delete -i)
 YQ_CMD_MERGE_OVERWRITE=("$yq" merge --inplace --overwrite --prettyPrint)
 YQ_CMD_MERGE=("$yq" merge --arrays=append --inplace)
 YQ_CMD_WRITE=("$yq" write --inplace -P)
-CSV_FILE_NAME="../../build/csv/ceph/$PLATFORM/manifests/rook-ceph.clusterserviceversion.yaml"
-CEPH_EXTERNAL_SCRIPT_FILE="../../deploy/examples/create-external-cluster-resources.py"
-ASSEMBLE_FILE_COMMON="../../deploy/olm/assemble/metadata-common.yaml"
-ASSEMBLE_FILE_OCP="../../deploy/olm/assemble/metadata-ocp.yaml"
+CSV_FILE_NAME="build/csv/ceph/$PLATFORM/manifests/rook-ceph.clusterserviceversion.yaml"
+CEPH_EXTERNAL_SCRIPT_FILE="deploy/examples/create-external-cluster-resources.py"
+ASSEMBLE_FILE_COMMON="deploy/olm/assemble/metadata-common.yaml"
+ASSEMBLE_FILE_OCP="deploy/olm/assemble/metadata-ocp.yaml"

 #############
 # FUNCTIONS #
 #############

 function generate_csv() {
-    kubectl kustomize ../../deploy/examples/ | "$operator_sdk" generate bundle --package="rook-ceph" --output-dir="../../build/csv/ceph/$PLATFORM" --extra-service-accounts=rook-ceph-default,rook-csi-rbd-provisioner-sa,rook-csi-rbd-plugin-sa,rook-csi-cephfs-provisioner-sa,rook-csi-nfs-provisioner-sa,rook-csi-nfs-plugin-sa,rook-csi-cephfs-plugin-sa,rook-ceph-system,rook-ceph-rgw,rook-ceph-purge-osd,rook-ceph-osd,rook-ceph-mgr,rook-ceph-cmd-reporter
+    kubectl kustomize deploy/examples/ | "$operator_sdk" generate bundle --package="rook-ceph" --output-dir="build/csv/ceph/$PLATFORM" --extra-service-accounts=rook-ceph-default,rook-csi-rbd-provisioner-sa,rook-csi-rbd-plugin-sa,rook-csi-cephfs-provisioner-sa,rook-csi-nfs-provisioner-sa,rook-csi-nfs-plugin-sa,rook-csi-cephfs-plugin-sa,rook-ceph-system,rook-ceph-rgw,rook-ceph-purge-osd,rook-ceph-osd,rook-ceph-mgr,rook-ceph-cmd-reporter

     # cleanup to get the expected state before merging the real data from assembles
     "${YQ_CMD_DELETE[@]}" "$CSV_FILE_NAME" 'spec.icon[*]'
@@ -38,7 +38,7 @@ function generate_csv() {
     "${YQ_CMD_MERGE[@]}" "$CSV_FILE_NAME" "$ASSEMBLE_FILE_OCP"

     # We don't need to include these files in csv as ocs-operator creates its own.
-    rm -rf "../../build/csv/ceph/$PLATFORM/manifests/rook-ceph-operator-config_v1_configmap.yaml"
+    rm -rf "build/csv/ceph/$PLATFORM/manifests/rook-ceph-operator-config_v1_configmap.yaml"

     # This change are just to make the CSV file as it was earlier and as ocs-operator reads.
     # Skipping this change for darwin since `sed -i` doesn't work with darwin properly.
@@ -51,9 +51,9 @@ function generate_csv() {
     sed -i 's/name: rook-ceph.v.*/name: rook-ceph.v{{.RookOperatorCsvVersion}}/g' "$CSV_FILE_NAME"
     sed -i 's/version: 0.0.0/version: {{.RookOperatorCsvVersion}}/g' "$CSV_FILE_NAME"

-    mv "$CSV_FILE_NAME" "../../build/csv/"
-    mv "../../build/csv/ceph/$PLATFORM/manifests/"* "../../build/csv/ceph/"
-    rm -rf "../../build/csv/ceph/$PLATFORM"
+    mv "$CSV_FILE_NAME" "build/csv/"
+    mv "build/csv/ceph/$PLATFORM/manifests/"* "build/csv/ceph/"
+    rm -rf "build/csv/ceph/$PLATFORM"
 }

 if [ "$PLATFORM" == "amd64" ]; then
diff --git a/images/ceph/Makefile b/images/ceph/Makefile
index e93dab7d9..6bc0670ce 100755
--- a/images/ceph/Makefile
+++ b/images/ceph/Makefile
@@ -32,7 +32,7 @@ GOHOST := GOOS=$(GOHOSTOS) GOARCH=$(GOHOSTARCH) go
 MANIFESTS_DIR=../../deploy/examples

 ifeq ($(BUILD_CONTEXT_DIR),)
-BUILD_CONTEXT_DIR := $(shell mktemp -d)
+BUILD_CONTEXT_DIR := $(shell realpath ../..)
 endif

 # Note: as of version 1.3 of operator-sdk, the url format changed to:
@@ -82,7 +82,7 @@ do.build:

 ifeq ($(INCLUDE_CSV_TEMPLATES),true)
 	@$(MAKE) csv
-	@cp -r ../../build/csv $(BUILD_CONTEXT_DIR)/ceph-csv-templates
+	@cp -r ../../build/csv/ $(BUILD_CONTEXT_DIR)/ceph-csv-templates/
 	@rm $(BUILD_CONTEXT_DIR)/ceph-csv-templates/csv-gen.sh
 	@$(MAKE) csv-clean

@@ -90,16 +90,16 @@ else
 	mkdir $(BUILD_CONTEXT_DIR)/ceph-csv-templates
 endif
 	@cd $(BUILD_CONTEXT_DIR) && $(SED_IN_PLACE) 's|BASEIMAGE|$(BASEIMAGE)|g' Dockerfile
-	@if [ -z "$(BUILD_CONTAINER_IMAGE)" ]; then\
-		$(DOCKERCMD) build $(BUILD_ARGS) \
-		--build-arg S5CMD_VERSION=$(S5CMD_VERSION) \
-		--build-arg S5CMD_ARCH=$(S5CMD_ARCH) \
-		-t $(CEPH_IMAGE) \
-		$(BUILD_CONTEXT_DIR);\
-	fi
-	@if [ -z "$(SAVE_BUILD_CONTEXT_DIR)" ]; then\
-		rm -fr $(BUILD_CONTEXT_DIR);\
-	fi
+#	@if [ -z "$(BUILD_CONTAINER_IMAGE)" ]; then\
+#		$(DOCKERCMD) build $(BUILD_ARGS) \
+#		--build-arg S5CMD_VERSION=$(S5CMD_VERSION) \
+#		--build-arg S5CMD_ARCH=$(S5CMD_ARCH) \
+#		-t $(CEPH_IMAGE) \
+#		$(BUILD_CONTEXT_DIR);\
+#	fi
+#	@if [ -z "$(SAVE_BUILD_CONTEXT_DIR)" ]; then\
+#		rm -fr $(BUILD_CONTEXT_DIR);\
+#	fi

 # call this before building multiple arches in parallel to prevent parallel build processes from
 # conflicting
@@ -122,9 +122,9 @@ $(OPERATOR_SDK):
 csv: $(OPERATOR_SDK) $(YQv3)
 	@echo generate csv with latest operator-sdk
 	@mkdir -p ../../build/csv/ceph
-	@../../build/csv/csv-gen.sh
+	@(cd ../../ && build/csv/csv-gen.sh)
 	@# #adding 2>/dev/null since CI doesn't seems to be creating bundle.Dockerfile file
-	@rm bundle.Dockerfile 2> /dev/null || true
+	@#rm bundle.Dockerfile 2> /dev/null || true

 csv-clean: ## Remove existing OLM files.
 	@rm -fr ../../build/csv/ceph/${go env GOARCH}
-- 
2.43.2

